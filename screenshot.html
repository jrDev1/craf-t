<html>

<head>
   <!--<script src="https://code.hnldesign.nl/hnl.mobileConsole.1.3.js?f004ea15"></script> -->

  	<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
	
	<!--Merge Images -->
	<script src="https://unpkg.com/merge-images"></script>

  	<!-- we import arjs version without NFT but with marker + location based support -->
  	<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  	<script src="aframe-text-geometry-component.min.js"></script>
	<script src="aframe-gif-shader.js"></script>
    	<script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
  	<script src="https://rawgit.com/mayognaise/aframe-gif-component/master/dist/aframe-gif-component.min.js"></script>
  	
	</head>
	 
	<body style="margin : 0px; overflow: hidden;">

        <a-scene embedded arjs='trackingMethod: best; patternRatio: 0.9; debugUIEnabled: false;' vr-mode-ui="enabled: false">
		
		<a-marker 
				  preset='custom' 
				  type='pattern' 
				  smooth='true' 
				  smoothCount='25'
				  smoothTolerance='6'
				  url='https://raw.githubusercontent.com/jrDev1/craf-t/master/FathersDayDog1.patt'
				registerevents>
     
        			<a-entity 
					  id="The GIF"
					  position="0 0.1 0" 
					  rotation="-90 0 0" 
					  scale="1.1 1.1 1" 
					  geometry="primitive:plane" 

					  material="shader:gif;src:url(https://raw.githubusercontent.com/jrDev1/craf-t/master/200w.gif);"
					  
					  gif="" 
					  transparent="false">
				</a-entity>

     		</a-marker>
														  
			<a-entity camera></a-entity>
      												    
	    </a-scene>
			
		<div style='position: fixed; top: 10px; width:100%; text-align: center; z-index: 1;'>
			
			    <button id="take_screenshot"> Screenshot</button>
			   	<a id="download-link"></a>								    											      
  				<p style="color:red;">Test Mode ver 0.3</p>
		
		</div>		
    
	</body>


    <script>
        var m = document.querySelector("a-marker")

	m.addEventListener("markerFound", (e)=>{
		console.log("found")
	})

	m.addEventListener("markerLost", (e)=>{
   		console.log("lost")
	})
	    
        function resizeCanvas(origCanvas, width, height) {
            let resizedCanvas = document.createElement("canvas");
            let resizedContext = resizedCanvas.getContext("2d");

            resizedCanvas.height = height;
            resizedCanvas.width = width;

            if (width > height) {
                // Landscape
                resizedContext.drawImage(origCanvas, 0, 0, width, height);
            } else {
                // Portrait
                var scale = height / width;
                var scaledHeight = origCanvas.width * scale;
                var scaledWidth = origCanvas.height * scale;
                var marginLeft = (origCanvas.width - scaledWidth) / 2;
//                 resizedContext.drawImage(origCanvas, marginLeft, 0, scaledWidth, scaledHeight);
		     // Portrait 
		    //resizedContext.drawImage(origCanvas, 0, 0, height, width);
		    //resizedContext.drawImage(origCanvas, marginLeft, 0, height, width);
		    //resizedContext.drawImage(origCanvas, 0, 0, scaledWidth, scaledHeight);
		    resizedContext.drawImage(origCanvas, -100, 100, height, scaledWidth);
		    console.log(scaledWidth + " Scaled " + scaledHeight);
            }

            return resizedCanvas.toDataURL();
        }

	    document.getElementById("take_screenshot").addEventListener("click", Screenshot);
												    
	function Screenshot() {
		
		//Pause the gif
		document.getElementById"(The GIF").pause();
		
            var aScene = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
            var frame = captureVideoFrame("video", "png");

            aScene = resizeCanvas(aScene, frame.width, frame.height);
            frame = frame.dataUri;
            mergeImages([frame, aScene]).then(b64 => {

                var link = document.getElementById("download-link", "png");
                link.setAttribute("download", "AR.png");
                link.setAttribute("href", b64);
                link.click();

		    //Pause the gif
		document.getElementById"(The GIF").play();
            });
        }

        function captureVideoFrame(video, format, width, height) {
            if (typeof video === 'string') {
                video = document.querySelector(video);
                console.log('Video:' + video);
            }

            format = format || 'jpeg';

            if (!video || (format !== 'png' && format !== 'jpeg')) {
                return false;
            }

            var canvas = document.createElement("CANVAS");

            canvas.width = width || video.videoWidth;
            canvas.height = height || video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            var dataUri = canvas.toDataURL('image/' + format);
            var data = dataUri.split(',')[1];
            var mimeType = dataUri.split(';')[0].slice(5)

            var bytes = window.atob(data);
            var buf = new ArrayBuffer(bytes.length);
            var arr = new Uint8Array(buf);

            for (var i = 0; i < bytes.length; i++) {
                arr[i] = bytes.charCodeAt(i);
            }

            var blob = new Blob([arr], { type: mimeType });
            return { blob: blob, dataUri: dataUri, format: format, width: canvas.width, height: canvas.height };
        };

        function loadImages(sources, callback) {
            var images = {};
            var loadedImages = 0;
            var numImages = 0;
            // get num of sources
            for (var src in sources) {
                numImages++;
            }
            for (var src in sources) {
                images[src] = new Image();
                images[src].onload = function () {
                    if (++loadedImages >= numImages) {
                        callback(images);
                    }
                };
                images[src].src = sources[src];
            }
        }

    </script>

</html>
